<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–∏–º—É–ª—è—Ü–∏—è Wa-Tor: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        #stats { margin-bottom: 10px; font-size: 1.2rem; }
        canvas {
            border: 2px solid #555;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
        }
        .controls { margin-top: 15px; display: flex; gap: 10px; }
        button {
            padding: 10px 20px; font-size: 1rem; cursor: pointer;
            background: #333; color: white; border: 1px solid #555; border-radius: 4px;
        }
        button:hover { background: #555; }
        #error-log { color: #ff5555; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ Wa-Tor (v2.0)</h1>
    
    <div id="stats">
        üêü –†—ã–±—ã: <span id="fish-count" style="color:#0f0">0</span> | 
        ü¶à –ê–∫—É–ª—ã: <span id="shark-count" style="color:#f55">0</span> | 
        –ü–æ–∫–æ–ª–µ–Ω–∏–µ: <span id="gen-count">0</span>
    </div>

    <canvas id="ocean" width="600" height="600"></canvas>
    <div id="error-log"></div>
    
    <div style="font-size: 0.9rem; color: #aaa; margin-top: 5px;">
        –õ–ö–ú ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –†—ã–±. –ü–ö–ú (–∏–ª–∏ Shift+–õ–ö–ú) ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ê–∫—É–ª.
    </div>

    <div class="controls">
        <button onclick="togglePause()" id="btn-pause">–°—Ç–∞—Ä—Ç / –ü–∞—É–∑–∞</button>
        <button onclick="restartGame()">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
        <button onclick="step()">–û–¥–∏–Ω —à–∞–≥ (Debug)</button>
    </div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    const CELL_SIZE = 6;
    const GRID_W = 100;
    const GRID_H = 100;
    
    const FISH_BREED_TIME = 20;
    const SHARK_BREED_TIME = 40;
    const SHARK_START_ENERGY = 15;
    const SHARK_EAT_ENERGY = 10;

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let canvas, ctx;
    let grid = [];
    let isPaused = false;
    let generation = 0;
    let lastTime = 0;
    const fpsInterval = 1000 / 30; // 30 FPS

    window.onload = () => {
        try {
            canvas = document.getElementById('ocean');
            ctx = canvas.getContext('2d');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
            canvas.addEventListener('mousedown', handleInput);
            canvas.oncontextmenu = (e) => e.preventDefault();

            restartGame();
            requestAnimationFrame(gameLoop);
            
        } catch (e) {
            logError("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + e.message);
        }
    };

    function logError(msg) {
        document.getElementById('error-log').innerText = "–û–®–ò–ë–ö–ê: " + msg;
        console.error(msg);
        isPaused = true;
    }

    function restartGame() {
        grid = new Array(GRID_W).fill(null).map(() => new Array(GRID_H).fill(null));
        generation = 0;
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const rand = Math.random();
                if (rand < 0.3) grid[x][y] = createFish();
                else if (rand > 0.98) grid[x][y] = createShark();
            }
        }
        draw();
        updateStats();
    }

    // --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---
    function gameLoop(timestamp) {
        requestAnimationFrame(gameLoop);

        if (isPaused) return;

        const elapsed = timestamp - lastTime;

        if (elapsed > fpsInterval) {
            lastTime = timestamp - (elapsed % fpsInterval);
            
            try {
                update();
                draw();
            } catch (e) {
                logError("–°–±–æ–π –≤ —Ü–∏–∫–ª–µ update: " + e.message);
            }
        }
    }

    function step() {
        // –î–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –∑–∞–≤–∏—Å–ª–æ
        isPaused = true; 
        update(); 
        draw();
    }

    function update() {
        // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –¥–≤–∏–∂–µ–Ω–∏—è
        for(let x=0; x<GRID_W; x++) {
            for(let y=0; y<GRID_H; y++) {
                if(grid[x][y]) grid[x][y].moved = false;
            }
        }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const creature = grid[x][y];
                if (!creature || creature.moved) continue;

                creature.moved = true; 

                if (creature.type === 'fish') updateFish(x, y, creature);
                else updateShark(x, y, creature);
            }
        }
        generation++;
        updateStats();
    }

    function updateFish(x, y, fish) {
        fish.breedTimer++;
        const neighbors = getNeighbors(x, y);
        const empty = neighbors.filter(n => grid[n.x][n.y] === null);

        if (empty.length > 0) {
            const move = empty[Math.floor(Math.random() * empty.length)];
            
            if (fish.breedTimer >= FISH_BREED_TIME) {
                fish.breedTimer = 0;
                grid[x][y] = createFish(); 
                grid[x][y].moved = true;
            } else {
                grid[x][y] = null;
            }
            grid[move.x][move.y] = fish;
        }
    }

    function updateShark(x, y, shark) {
        shark.breedTimer++;
        shark.energy--;

        if (shark.energy <= 0) {
            grid[x][y] = null; // –°–º–µ—Ä—Ç—å
            return;
        }

        const neighbors = getNeighbors(x, y);
        const fishSpots = neighbors.filter(n => grid[n.x][n.y] && grid[n.x][n.y].type === 'fish');
        const emptySpots = neighbors.filter(n => grid[n.x][n.y] === null);

        let target = null;
        
        if (fishSpots.length > 0) {
            target = fishSpots[Math.floor(Math.random() * fishSpots.length)];
            shark.energy += SHARK_EAT_ENERGY;
        } else if (emptySpots.length > 0) {
            target = emptySpots[Math.floor(Math.random() * emptySpots.length)];
        }

        if (target) {
            if (shark.breedTimer >= SHARK_BREED_TIME) {
                shark.breedTimer = 0;
                grid[x][y] = createShark();
                grid[x][y].moved = true;
            } else {
                grid[x][y] = null;
            }
            grid[target.x][target.y] = shark;
        }
    }

    function getNeighbors(x, y) {
        const res = [];
        const dirs = [[0,-1], [0,1], [-1,0], [1,0]];
        for (let d of dirs) {
            let nx = (x + d[0] + GRID_W) % GRID_W;
            let ny = (y + d[1] + GRID_H) % GRID_H;
            res.push({x: nx, y: ny});
        }
        return res;
    }

    function createFish() { return { type: 'fish', breedTimer: Math.floor(Math.random()*FISH_BREED_TIME), moved: false }; }
    function createShark() { return { type: 'shark', breedTimer: Math.floor(Math.random()*SHARK_BREED_TIME), energy: SHARK_START_ENERGY, moved: false }; }

    function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let f = 0, s = 0;
        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const c = grid[x][y];
                if (!c) continue;
                
                if (c.type === 'fish') {
                    ctx.fillStyle = '#00ff7f';
                    f++;
                } else {
                    ctx.fillStyle = (c.energy < 5) ? '#8b0000' : '#ff4040';
                    s++;
                }
                ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE-1, CELL_SIZE-1);
            }
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        window.fishCountRef = f;
        window.sharkCountRef = s;
    }

    function updateStats() {
        document.getElementById('fish-count').innerText = window.fishCountRef || 0;
        document.getElementById('shark-count').innerText = window.sharkCountRef || 0;
        document.getElementById('gen-count').innerText = generation;
    }

    function togglePause() {
        isPaused = !isPaused;
    }

    function handleInput(e) {
        const rect = canvas.getBoundingClientRect();
        const mx = Math.floor((e.clientX - rect.left) / CELL_SIZE);
        const my = Math.floor((e.clientY - rect.top) / CELL_SIZE);
        
        if (mx >=0 && mx < GRID_W && my >=0 && my < GRID_H) {
            if (e.button === 2 || e.shiftKey) grid[mx][my] = createShark();
            else grid[mx][my] = createFish();
            draw();
        }
    }
</script>
</body>
</html>
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
        button:hover { background: #555; }
        .legend { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ Wa-Tor</h1>
    
    <div id="stats">
        üêü –†—ã–±—ã: <span id="fish-count" style="color:#0f0">0</span> | 
        ü¶à –ê–∫—É–ª—ã: <span id="shark-count" style="color:#f55">0</span> | 
        –ü–æ–∫–æ–ª–µ–Ω–∏–µ: <span id="gen-count">0</span>
    </div>

    <canvas id="ocean" width="600" height="600"></canvas>
    <div class="legend">–ö–ª–∏–∫–Ω–∏ –õ–ö–ú, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –†—ã–±. –ö–ª–∏–∫–Ω–∏ –ü–ö–ú (–∏–ª–∏ Shift+–ö–ª–∏–∫), —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ê–∫—É–ª.</div>

    <div class="controls">
        <button onclick="togglePause()" id="btn-pause">–ü–∞—É–∑–∞</button>
        <button onclick="resetSim()">–°–±—Ä–æ—Å / –†–µ—Å—Ç–∞—Ä—Ç</button>
    </div>

<script>
    /** –ù–ê–°–¢–†–û–ô–ö–ò –°–ò–ú–£–õ–Ø–¶–ò–ò **/
    const CELL_SIZE = 6;       // –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏ (–ø–∏–∫—Å–µ–ª–µ–π)
    const GRID_W = 100;        // –®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (–≤ –∫–ª–µ—Ç–∫–∞—Ö)
    const GRID_H = 100;        // –í—ã—Å–æ—Ç–∞ –ø–æ–ª—è (–≤ –∫–ª–µ—Ç–∫–∞—Ö)
    
    const FISH_BREED_TIME = 20; // –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ —Ä—ã–±–∞ —Ä–æ–∂–∞–µ—Ç
    const SHARK_BREED_TIME = 40;// –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –∞–∫—É–ª–∞ —Ä–æ–∂–∞–µ—Ç
    const SHARK_START_ENERGY = 15; // –°–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –∞–∫—É–ª–∞ –∂–∏–≤–µ—Ç –±–µ–∑ –µ–¥—ã
    const SHARK_EAT_ENERGY = 10;   // –°–∫–æ–ª—å–∫–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–∞–µ—Ç —Å—ä–µ–¥–µ–Ω–Ω–∞—è —Ä—ã–±–∞

    // –¶–≤–µ—Ç–∞
    const COLOR_OCEAN = '#000000';
    const COLOR_FISH = '#00ff7f';
    const COLOR_SHARK = '#ff4040';
    const COLOR_SHARK_HUNGRY = '#8b0000'; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –≥–æ–ª–æ–¥–Ω–æ–π –∞–∫—É–ª—ã

    let canvas, ctx;
    let grid = [];     // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let nextGrid = []; // –ë—É—Ñ–µ—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–≤–∏–∂–µ–Ω–∏—è)
    let isPaused = false;
    let animationId;
    let generation = 0;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => {
        canvas = document.getElementById('ocean');
        ctx = canvas.getContext('2d');
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ (–†–µ–∂–∏–º –ë–æ–≥–∞)
        canvas.addEventListener('mousedown', handleInput);
        canvas.oncontextmenu = (e) => e.preventDefault(); // –ë–ª–æ–∫ –º–µ–Ω—é –ü–ö–ú

        resetSim();
        loop();
    };

    function resetSim() {
        grid = createGrid();
        generation = 0;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const rand = Math.random();
                if (rand < 0.3) {
                    grid[x][y] = createFish();
                } else if (rand > 0.98) { // –ê–∫—É–ª –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞–ª–æ
                    grid[x][y] = createShark();
                }
            }
        }
        draw();
        updateStats();
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤
    function createFish() {
        return { type: 'fish', breedTimer: Math.floor(Math.random() * FISH_BREED_TIME), moved: false };
    }
    function createShark() {
        return { 
            type: 'shark', 
            breedTimer: Math.floor(Math.random() * SHARK_BREED_TIME), 
            energy: SHARK_START_ENERGY,
            moved: false 
        };
    }
    function createGrid() {
        let arr = new Array(GRID_W);
        for (let i = 0; i < GRID_W; i++) {
            arr[i] = new Array(GRID_H).fill(null);
        }
        return arr;
    }

    // –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–ë–ù–û–í–õ–ï–ù–ò–Ø
    function update() {
        if (isPaused) return;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö
        for(let x=0; x<GRID_W; x++) for(let y=0; y<GRID_H; y++) {
            if(grid[x][y]) grid[x][y].moved = false;
        }

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º—É –ø–æ–ª—é
        // –í–∞–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–æ–ø–∏—é —Å—Å—ã–ª–æ–∫ –∏–ª–∏ –æ—á–µ–Ω—å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã
        // –í —ç—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—ã –±—É–¥–µ–º –¥–≤–∏–≥–∞—Ç—å —Å—É—â–µ—Å—Ç–≤ –ø—Ä—è–º–æ –≤ –º–∞—Å—Å–∏–≤–µ grid,
        // –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–ª–∞–≥ 'moved', —á—Ç–æ–±—ã –Ω–µ –¥–≤–∏–≥–∞—Ç—å –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –¥–≤–∞–∂–¥—ã –∑–∞ –∫–∞–¥—Ä.
        
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ö–æ–¥–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "—Å–Ω–æ—Å–∞" –¥–≤–∏–∂–µ–Ω–∏—è –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É
        // (–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∑–¥–µ—Å—å –ª–∏–Ω–µ–π–Ω—ã–π –æ–±—Ö–æ–¥, –Ω–æ –≤ –∏–¥–µ–∞–ª–µ –Ω—É–∂–µ–Ω —Ä–∞–Ω–¥–æ–º)

        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const creature = grid[x][y];
                
                // –ï—Å–ª–∏ —Ç—É—Ç –ø—É—Å—Ç–æ –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤–æ —É–∂–µ —Ö–æ–¥–∏–ª–æ –≤ —ç—Ç–æ—Ç —Ö–æ–¥
                if (!creature || creature.moved) continue;

                creature.moved = true; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ—Ö–æ–¥–∏–ª

                if (creature.type === 'fish') {
                    updateFish(x, y, creature);
                } else if (creature.type === 'shark') {
                    updateShark(x, y, creature);
                }
            }
        }
        generation++;
        updateStats();
    }

    /** –õ–û–ì–ò–ö–ê –†–´–ë–´ **/
    function updateFish(x, y, fish) {
        fish.breedTimer++;
        
        // 1. –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
        const neighbors = getNeighbors(x, y);
        const emptySpots = neighbors.filter(n => grid[n.x][n.y] === null);

        if (emptySpots.length > 0) {
            // –î–≤–∏–≥–∞–µ–º—Å—è –≤ —Å–ª—É—á–∞–π–Ω—É—é –ø—É—Å—Ç—É—é
            const move = emptySpots[Math.floor(Math.random() * emptySpots.length)];
            
            // –ï—Å–ª–∏ –ø–æ—Ä–∞ —Ä–∞–∑–º–Ω–æ–∂–∞—Ç—å—Å—è
            if (fish.breedTimer >= FISH_BREED_TIME) {
                fish.breedTimer = 0;
                grid[x][y] = createFish(); // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Ç–æ–º–∫–∞ –Ω–∞ —Å—Ç–∞—Ä–æ–º –º–µ—Å—Ç–µ (—É–∂–µ –ø–æ—Ö–æ–¥–∏–ª)
                grid[x][y].moved = true;   // –ù–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω—ã–π –≤ —ç—Ç–æ—Ç —Ö–æ–¥ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
            } else {
                grid[x][y] = null; // –°—Ç–∞—Ä–æ–µ –º–µ—Å—Ç–æ –ø—É—Å—Ç–æ
            }
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ä—ã–±—É
            grid[move.x][move.y] = fish;
        }
        // –ï—Å–ª–∏ –º–µ—Å—Ç –Ω–µ—Ç, —Ä—ã–±–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ (–∏ –Ω–µ —Ä–∞–∑–º–Ω–æ–∂–∞–µ—Ç—Å—è)
    }

    /** –õ–û–ì–ò–ö–ê –ê–ö–£–õ–´ (–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç) **/
    function updateShark(x, y, shark) {
        shark.breedTimer++;
        shark.energy--;

        if (shark.energy <= 0) {
            grid[x][y] = null; // –°–º–µ—Ä—Ç—å –æ—Ç –≥–æ–ª–æ–¥–∞
            return;
        }

        const neighbors = getNeighbors(x, y);
        const fishSpots = neighbors.filter(n => grid[n.x][n.y] && grid[n.x][n.y].type === 'fish');
        const emptySpots = neighbors.filter(n => grid[n.x][n.y] === null);

        let target = null;
        let ate = false;

        // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ï–î–ê (–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: –ê—Ç–∞–∫–∞)
        if (fishSpots.length > 0) {
            target = fishSpots[Math.floor(Math.random() * fishSpots.length)];
            shark.energy += SHARK_EAT_ENERGY; // –ü–æ–∫—É—à–∞–ª–∞
            ate = true;
        } 
        // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –î–í–ò–ñ–ï–ù–ò–ï (–ï—Å–ª–∏ –Ω–µ—Ç –µ–¥—ã)
        else if (emptySpots.length > 0) {
            target = emptySpots[Math.floor(Math.random() * emptySpots.length)];
        }

        if (target) {
            // –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –∞–∫—É–ª—ã
            if (shark.breedTimer >= SHARK_BREED_TIME) {
                shark.breedTimer = 0;
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–±–µ–Ω–∫–∞ –Ω–∞ —Å—Ç–∞—Ä–æ–º –º–µ—Å—Ç–µ
                grid[x][y] = createShark(); 
                grid[x][y].moved = true; 
                // –ù–æ–≤–∞—è –∞–∫—É–ª–∞ –Ω–∞—Å–ª–µ–¥—É–µ—Ç —á–∞—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏ –∏–ª–∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –±–∞–∑–æ–≤–æ–π? 
                // –ü–æ –∫–ª–∞—Å—Å–∏–∫–µ - —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –±–∞–∑–æ–≤–æ–π.
            } else {
                grid[x][y] = null;
            }

            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∞–∫—É–ª—É (—Å—ä–µ–¥–∞—è —Ä—ã–±—É, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–∞–º –±—ã–ª–∞)
            grid[target.x][target.y] = shark;
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Å–µ–¥–µ–π —Å —É—á–µ—Ç–æ–º –¢–û–ü–û–õ–û–ì–ò–ò –¢–û–†–ê (–º–∏—Ä –∫—Ä—É–≥–ª—ã–π)
    function getNeighbors(x, y) {
        const result = [];
        // –°–º–µ—â–µ–Ω–∏—è: –í–µ—Ä—Ö, –ù–∏–∑, –õ–µ–≤–æ, –ü—Ä–∞–≤–æ
        const dirs = [[0, -1], [0, 1], [-1, 0], [1, 0]];
        
        for (let d of dirs) {
            // –§–æ—Ä–º—É–ª–∞ —Ç–æ—Ä–∞: (—Ç–µ–∫—É—â–∞—è + —Å–º–µ—â–µ–Ω–∏–µ + —Ä–∞–∑–º–µ—Ä) % —Ä–∞–∑–º–µ—Ä
            let nx = (x + d[0] + GRID_W) % GRID_W;
            let ny = (y + d[1] + GRID_H) % GRID_H;
            result.push({x: nx, y: ny});
        }
        return result;
    }

    // –û–¢–†–ò–°–û–í–ö–ê
    function draw() {
        // –û—á–∏—Å—Ç–∫–∞
        ctx.fillStyle = COLOR_OCEAN;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let fishCount = 0;
        let sharkCount = 0;

        for (let x = 0; x < GRID_W; x++) {
            for (let y = 0; y < GRID_H; y++) {
                const cell = grid[x][y];
                if (!cell) continue;

                const px = x * CELL_SIZE;
                const py = y * CELL_SIZE;

                if (cell.type === 'fish') {
                    fishCount++;
                    ctx.fillStyle = COLOR_FISH;
                    ctx.fillRect(px, py, CELL_SIZE-1, CELL_SIZE-1);
                } else if (cell.type === 'shark') {
                    sharkCount++;
                    // –ï—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏–∏ –º–∞–ª–æ - —Ç–µ–º–Ω–µ–µ—Ç
                    ctx.fillStyle = (cell.energy < 5) ? COLOR_SHARK_HUNGRY : COLOR_SHARK;
                    ctx.fillRect(px, py, CELL_SIZE-1, CELL_SIZE-1);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ DOM –Ω–µ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä, –∞ —Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –±—É–¥–µ—Ç, –Ω–æ –∑–¥–µ—Å—å –Ω–æ—Ä–º
        document.getElementById('fish-count').innerText = fishCount;
        document.getElementById('shark-count').innerText = sharkCount;
        document.getElementById('gen-count').innerText = generation;
    }

    function loop() {
        // –ó–∞–º–µ–¥–ª—è–µ–º —Ü–∏–∫–ª, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º setTimeout)
        // –ù–æ requestAnimationFrame + setTimeout –≤–Ω—É—Ç—Ä–∏ - –ø—Ä–æ—â–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        setTimeout(() => {
            requestAnimationFrame(loop);
            update();
            draw();
        }, 1000 / 30); // 30 FPS —Ü–µ–ª–µ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('btn-pause').innerText = isPaused ? "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" : "–ü–∞—É–∑–∞";
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à–∫–æ–π
    function handleInput(e) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const gx = Math.floor(mouseX / CELL_SIZE);
        const gy = Math.floor(mouseY / CELL_SIZE);

        if (gx >= 0 && gx < GRID_W && gy >= 0 && gy < GRID_H) {
            // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –∏–ª–∏ –®–∏—Ñ—Ç - –ê–∫—É–ª–∞, –∏–Ω–∞—á–µ –†—ã–±–∞
            if (e.button === 2 || e.shiftKey) {
                grid[gx][gy] = createShark();
            } else {
                grid[gx][gy] = createFish();
            }
            draw();
        }
    }

</script>
</body>
</html>
